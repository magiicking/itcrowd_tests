#Область СлужебныеПроцедурыИФункции

Процедура ОформитьНаОсновании(Форма, СотрудникСсылка, ИмяКоманды, ПараметрыОткрытияФормы = Неопределено) Экспорт
	
	Если Не ЗначениеЗаполнено(СотрудникСсылка) Тогда 
		Возврат;
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Форма", Форма);
	ДополнительныеПараметры.Вставить("СотрудникСсылка", СотрудникСсылка);
	ДополнительныеПараметры.Вставить("ИмяКоманды", ИмяКоманды);
	ДополнительныеПараметры.Вставить("ЗаписатьДанные", Истина);
	ДополнительныеПараметры.Вставить("ПараметрыОткрытияФормы", ПараметрыОткрытияФормы);
	
	// Если данные сотрудника еще не записаны, предложим записать.
	Если Форма.Модифицированность Или Форма.Параметры.Свойство("Ключ") И Форма.Параметры.Ключ.Пустая() Тогда
		
		ТекстВопроса = НСтр("ru = 'Сотрудник еще не записан.
							|Записать и продолжить?'");
							
		Оповещение = Новый ОписаниеОповещения("ОформитьНаОснованииПродолжение", ЭтотОбъект, ДополнительныеПараметры);					
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет, НСтр("ru = '1С:Предприятие'"));
		
	Иначе 
		
		ДополнительныеПараметры.ЗаписатьДанные = Ложь;
		ОформитьНаОснованииЗавершение(КодВозвратаДиалога.Да, ДополнительныеПараметры);
		
	КонецЕсли; 
	
КонецПроцедуры

Процедура ОформитьНаОснованииПродолжение(Ответ, ДополнительныеПараметры) Экспорт

	Если Ответ <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	Форма = ДополнительныеПараметры.Форма;
	
	Если ДополнительныеПараметры.ЗаписатьДанные Тогда
		Оповещение = Новый ОписаниеОповещения("ОформитьНаОснованииЗавершение", ЭтотОбъект, ДополнительныеПараметры);
		Форма.ЗаписатьНаКлиенте(Ложь, Оповещение);
	Иначе 
		ПараметрыЗаписи = Новый Структура;
		ОформитьНаОснованииЗавершение(ПараметрыЗаписи, ДополнительныеПараметры);
	КонецЕсли; 
	
КонецПроцедуры

Процедура ОформитьНаОснованииЗавершение(ПараметрыЗаписи, ДополнительныеПараметры) Экспорт

	Форма = ДополнительныеПараметры.Форма;
	СотрудникСсылка = ДополнительныеПараметры.СотрудникСсылка;
	ИмяКоманды = ДополнительныеПараметры.ИмяКоманды;
	
	Если ДополнительныеПараметры.ЗаписатьДанные И Не Форма.Записать(ПараметрыЗаписи) Тогда
		Возврат;
	КонецЕсли; 
	
	УстановитьДополнительныйПараметрПоИмениКомандыВводаНаОсновании(ИмяКоманды, ДополнительныеПараметры);
	
	ПолноеИмяОбъекта = ПолноеИмяОбъектаМетаданныхПоИмениКомандыВводаНаОсновании(ИмяКоманды);
	
	Если СтрНачинаетсяС(ПолноеИмяОбъекта, "Документы.") Тогда
		ПутьКФормеОбъекта = СтрЗаменить(ПолноеИмяОбъекта, "Документы.", "Документ.") + ".ФормаОбъекта";
	Иначе
		ПутьКФормеОбъекта = СтрЗаменить(ПолноеИмяОбъекта, "Справочники.", "Справочник.") + ".ФормаОбъекта";
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	Если ДополнительныеПараметры.Свойство("ПараметрыОткрытияФормы")
		И ЗначениеЗаполнено(ДополнительныеПараметры.ПараметрыОткрытияФормы) Тогда
		ПараметрыОткрытияФормы = ДополнительныеПараметры.ПараметрыОткрытияФормы;
		Для каждого КлючИЗначение Из ПараметрыОткрытияФормы Цикл
			ПараметрыФормы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	
	ПараметрыФормы.Вставить("Основание", СотрудникСсылка);
	ОткрытьФорму(ПутьКФормеОбъекта, ПараметрыФормы, Форма);
	
КонецПроцедуры

Процедура УстановитьДополнительныйПараметрПоИмениКомандыВводаНаОсновании(ИмяКоманды, ДополнительныеПараметры)
	
	НомерСимвола = СтрНайти(ИмяКоманды, "__");
	Если НомерСимвола > 0 Тогда
		
		ИдентификаторВидаДокументаСтрока = Прав(ИмяКоманды, 36);
		ИмяКоманды = Лев(ИмяКоманды, НомерСимвола - 1);
		
		Если ДополнительныеПараметры.ПараметрыОткрытияФормы = Неопределено Тогда
			ДополнительныеПараметры.ПараметрыОткрытияФормы = Новый Структура;
		КонецЕсли;
		ДополнительныеПараметры.ПараметрыОткрытияФормы.Вставить("ДополнительныйПараметр", Новый УникальныйИдентификатор(СтрЗаменить(ИдентификаторВидаДокументаСтрока, "_", "-")));
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает полное имя объекта метаданных по имени команды ввода на основании.
//
Функция ПолноеИмяОбъектаМетаданныхПоИмениКомандыВводаНаОсновании(ИмяКоманды)
	
	ПолноеИмяОбъектаМетаданных = СтрЗаменить(ИмяКоманды, "КомандаВводаНаОсновании_", "");
	ПозицияПодчеркивания = СтрНайти(ПолноеИмяОбъектаМетаданных, "_");
	
	Если ПозицияПодчеркивания = 0 Тогда
		Возврат ПолноеИмяОбъектаМетаданных;
	КонецЕсли;
	
	Возврат Лев(ПолноеИмяОбъектаМетаданных, ПозицияПодчеркивания - 1) + "." + Сред(ПолноеИмяОбъектаМетаданных, ПозицияПодчеркивания + 1);
	
КонецФункции

#КонецОбласти